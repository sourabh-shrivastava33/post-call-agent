// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  
 
}

model Meeting{
  id  String @id @default(cuid())
  meetingUrl String 
  startTime DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status MeetingStatus @default(SCHEDULED)
  failureReason String? 
  transcriptTimelines TranscriptSegment[]
  meetingBotSession MeetingBotSession[]
  executionArtifacts ExecutionArtifact[]
captionEvents CaptionEvent[]
  interruption EmailFollowUpInterruption[]
  emailDraft EmailDraft[]

}

model TranscriptSegment{
id String @id @default(cuid())
meetingId String
startTime DateTime
endTime DateTime
text String
speaker String
source SourceType @default(CAPTION)
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
meeting Meeting @relation(fields: [meetingId],references: [id])

 @@index([meetingId])
}

model MeetingBotSession{
  id String @id @default(cuid())
  meetingId String 
  browserSessionId String
joinStartAt DateTime? 
joinEndAt DateTime?
joinSuccess Boolean @default(false)
failureReason String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  meeting Meeting @relation(fields: [meetingId],references: [id])

  @@index([meetingId])
}


model ExecutionArtifact {
  id              String   @id @default(cuid())
  meetingId       String
  type            ExecutionArtifactType
  title           String
  summary         String
  owner           String?
  dueDate         DateTime?
  confidence      Float
  pageId     String?
  status          ExecutionArtifactStatus @default(PLANNED)
  origin          ExecutionArtifactOrigin @default(DEFAULT)
  externalId      String @unique
  sourceStartTime DateTime
  sourceEndTime   DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  meeting         Meeting  @relation(fields: [meetingId], references: [id])

  @@index([meetingId])
  @@index([externalId])
}




model CaptionEvent {
  id             String            @id @default(cuid())
  meetingId      String
  sequenceNumber Int
  observedAt     DateTime
  rawText        String
  speakerLabel  String?
  isPartial      Boolean           @default(true)
  source         SourceType  @default(CAPTION)

  createdAt      DateTime          @default(now())

  meeting        Meeting           @relation(fields: [meetingId], references: [id])

  @@index([meetingId])
  @@index([meetingId, sequenceNumber])
}



model EmailFollowUpInterruption {
  id          String   @id @default(cuid())
  meetingId   String

  toolName    String   // "sendFollowupEmail"

  to          String?
  subject     String
  body        String

  status      EmailFollowUpStatus @default(PENDING)

  expiresAt   DateTime

  decidedAt   DateTime?
  decidedBy   String?

  createdAt   DateTime @default(now())

  meeting     Meeting  @relation(fields: [meetingId], references: [id])
  emailDraft  EmailDraft[]

  @@index([meetingId])
  @@index([status])
}



model EmailDraft{
  id String            @id @default(cuid())
  meetingId      String
  to_original String?
  to_confirmed String?
  interruption_id String @unique
  subject String
  edited_subject String?
  original_body String
  edited_body String?
  createdAt  DateTime          @default(now())
interruption EmailFollowUpInterruption @relation(fields: [interruption_id],references: [id])
   meeting Meeting @relation(fields: [meetingId],references: [id])
 @@index([meetingId])
}


model SlackEvent {
  id          String   @id
  receivedAt DateTime @default(now())
}




enum SourceType {
  CAPTION
  STT
}
enum ExecutionArtifactType {
ACTION
BLOCKER
PENDING
RISK
DECISION
}


enum EmailFollowUpStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}


enum ConfidenceType {
  HIGH 
  MEDIUM 
  LOW

}
enum MeetingStatus {
  SCHEDULED
  JOINED
  CAPTURING
  CAPTURED
WORKFLOW_STARTED
WORKFLOW_ENDED
  FAILED
}

enum ExecutionArtifactOrigin {
  ACTION_ITEMS_AGENT
  BLOCKER_AGENT
DEFAULT
}

enum ExecutionArtifactStatus {
  PLANNED
  CONFIRMED
  BLOCKED
  COMPLETED
}
